# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
jobs:
  build:
    machine:
        image: ubuntu-1604:201903-01 
    steps:
      - add_ssh_keys:
          fingerprints:
            - "f8:5b:5f:b6:16:e8:f9:22:06:fc:61:98:e3:25:80:19"
      - checkout
      
      - run:
          name: "Pull Submodules"
          command: |
            git submodule init
            git submodule update --remote
            ls
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            sudo mv /tmp/docker/* /usr/bin
      # This should go into custom primary image, here's only for the sake of explanation
      - run:
          name: Install Docker Compose
          command: |
            set -x
            curl -L https://github.com/docker/compose/releases/download/1.11.2/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose


      - run:
          name: Start container and verify it's working
          command: |
            set -x
            cd Frontend
            git checkout remotes/origin/logout
            cd ..
            cd Backend
            git checkout remotes/origin/dockerization
            cd ..
            docker-compose up -d
            curl --retry 10 --retry-delay 1 --retry-connrefused http://localhost:3000
            curl --retry 10 --retry-delay 1 --retry-connrefused http://localhost:5000
            mysql -u root -h localhost -P 3306 -p
            squizz
